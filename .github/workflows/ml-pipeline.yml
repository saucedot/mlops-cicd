name: ML Pipeline CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run unit tests
      run: |
        pytest test_model.py -v
        
    - name: Train model
      run: |
        python train.py
        
    - name: Upload model artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: models/model.pkl
        
    - name: Upload metrics
      uses: actions/upload-artifact@v4
      with:
        name: metrics
        path: metrics.json

    - name: Setup CML
      uses: iterative/setup-cml@v2
      
    - name: Generate performance report
      env:
        REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
      run: |
        # Create report with metrics
        echo "## Model Performance Report" > report.md
        echo "" >> report.md
        cat metrics.json | python -c "import sys, json; data=json.load(sys.stdin); print(f\"**Accuracy:** {data['accuracy']:.3f}\")" >> report.md
        cat metrics.json | python -c "import sys, json; data=json.load(sys.stdin); print(f\"**F1 Score:** {data['f1_score']:.3f}\")" >> report.md
        echo "" >> report.md
        
        # Post report as PR comment
        cml comment create report.md
